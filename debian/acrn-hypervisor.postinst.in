#!/bin/sh
# postinst script for acrn-hypervisor
#
# see: dh_installdeb(1)

set -e

ACRNDIR=@acrndir@

. /usr/share/debconf/confmodule

db_get acrn-hypervisor/board
BOARD=${RET}

SCENARIOS=$(ls -1 ${ACRNDIR}/acrn.${BOARD}.uefi.*.bin \
       | sed "s%${ACRNDIR}/acrn.${BOARD}\.uefi\.\(.*\)\.bin%\1%g" \
       | sort | awk '{s=s (s?OFS:x) $1} END {print s}' OFS=", ")

db_subst acrn-hypervisor/scenario scenariolist ${SCENARIOS}
db_clear
db_input critical acrn-hypervisor/scenario || true
db_go || true

db_get acrn-hypervisor/scenario
SCENARIO=${RET}

ACRNOUT="${ACRNDIR}/acrn.${BOARD}.uefi.${SCENARIO}.32.out"
ACRNCFG="${ACRNDIR}/acrn.${BOARD}.uefi.${SCENARIO}.config"
ACRNMAP="${ACRNDIR}/acrn.${BOARD}.uefi.${SCENARIO}.map"
ACRNBIN="${ACRNDIR}/acrn.${BOARD}.uefi.${SCENARIO}.bin"

case "$1" in
    configure)
        if [ -f ${ACRNOUT} ] && [ -f ${ACRNCFG} ] && [ -f ${ACRNMAP} ] && [ -f ${ACRNBIN} ]; then
            cp ${ACRNOUT} /boot/acrn-@acrnversion@.out
            cp ${ACRNCFG} /boot/acrn-@acrnversion@.config
            cp ${ACRNMAP} /boot/acrn-@acrnversion@.map
            cp ${ACRNBIN} /boot/acrn-@acrnversion@.bin
            if command -v update-grub > /dev/null && [ -d /boot/grub ]; then
                update-grub || :
            fi
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
